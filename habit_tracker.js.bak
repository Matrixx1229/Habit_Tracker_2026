import React, { useState, useEffect, useMemo } from 'react';
import { Check, ChevronLeft, ChevronRight, BarChart2, TrendingUp, Calendar, Download, Plus, Trash2, Trophy, AlertCircle } from 'lucide-react';

// --- Utils ---

const DAYS_IN_MONTH = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
const MONTH_NAMES = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

const INITIAL_HABITS = [
  "Drink 2L Water",
  "Exercise 30 mins",
  "Read 20 Pages",
  "Meditate 10 mins",
  "Sleep by 11 PM",
  "No Added Sugar",
  "Walk 10k Steps",
  "Journaling",
  "Learn New Skill",
  "Quality Family Time"
];

// Generate initial empty data structure
const generateInitialData = () => {
  const data = {};
  MONTH_NAMES.forEach((month, mIndex) => {
    data[mIndex] = INITIAL_HABITS.map((habit, hIndex) => ({
      id: `h-${hIndex}`,
      name: habit,
      completedDays: [] // Array of day numbers (1-31)
    }));
  });
  return data;
};

// --- Components ---

const ProgressBar = ({ percentage, colorClass = "bg-blue-500" }) => (
  <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2">
    <div className={`${colorClass} h-2.5 rounded-full transition-all duration-500`} style={{ width: `${percentage}%` }}></div>
  </div>
);

const StatCard = ({ title, value, subtext, icon: Icon, color }) => (
  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-start space-x-4">
    <div className={`p-3 rounded-lg ${color} bg-opacity-10 text-${color.replace('bg-', '')}`}>
      <Icon size={24} className={color.replace('bg-', 'text-')} />
    </div>
    <div>
      <p className="text-sm text-slate-500 font-medium">{title}</p>
      <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
      {subtext && <p className="text-xs text-slate-400 mt-1">{subtext}</p>}
    </div>
  </div>
);

export default function HabitTracker() {
  const [currentMonth, setCurrentMonth] = useState(0); // 0 = Jan
  const [habitData, setHabitData] = useState(generateInitialData);
  const [newHabitName, setNewHabitName] = useState("");
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  // --- Actions ---

  const toggleDay = (habitIndex, day) => {
    setHabitData(prev => {
      const newData = { ...prev };
      const currentHabits = [...newData[currentMonth]];
      const habit = { ...currentHabits[habitIndex] };
      
      if (habit.completedDays.includes(day)) {
        habit.completedDays = habit.completedDays.filter(d => d !== day);
      } else {
        habit.completedDays = [...habit.completedDays, day];
      }
      
      currentHabits[habitIndex] = habit;
      newData[currentMonth] = currentHabits;
      return newData;
    });
  };

  const addHabit = () => {
    if (!newHabitName.trim()) return;
    setHabitData(prev => {
      const newData = { ...prev };
      // Add to all months to keep consistency or just current? 
      // Usually spreadsheet logic implies adding a row. Let's add to all months for consistency.
      Object.keys(newData).forEach(mKey => {
        newData[mKey] = [
          ...newData[mKey],
          { id: `h-${Date.now()}`, name: newHabitName, completedDays: [] }
        ];
      });
      return newData;
    });
    setNewHabitName("");
  };

  const deleteHabit = (habitIndex) => {
    if (!confirm("Delete this habit from all months?")) return;
    setHabitData(prev => {
      const newData = { ...prev };
      Object.keys(newData).forEach(mKey => {
        newData[mKey] = newData[mKey].filter((_, idx) => idx !== habitIndex);
      });
      return newData;
    });
  };

  const exportToCSV = () => {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Month,Habit,Day,Status\n";

    Object.keys(habitData).forEach(mIndex => {
      const monthName = MONTH_NAMES[mIndex];
      const habits = habitData[mIndex];
      const daysInMonth = DAYS_IN_MONTH[mIndex];

      habits.forEach(habit => {
        for (let d = 1; d <= daysInMonth; d++) {
          const status = habit.completedDays.includes(d) ? "Completed" : "Missed";
          csvContent += `${monthName},${habit.name},${d},${status}\n`;
        }
      });
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "habit_tracker_data.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- Analytics Calculations ---

  const analytics = useMemo(() => {
    const habits = habitData[currentMonth];
    const totalDays = DAYS_IN_MONTH[currentMonth];
    
    // 1. Overall Completion Rate
    const totalPossibleChecks = habits.length * totalDays;
    const totalChecks = habits.reduce((acc, h) => acc + h.completedDays.length, 0);
    const completionRate = totalPossibleChecks > 0 ? Math.round((totalChecks / totalPossibleChecks) * 100) : 0;

    // 2. Best Habit
    let bestHabit = habits[0];
    let maxChecks = -1;
    habits.forEach(h => {
      if (h.completedDays.length > maxChecks) {
        maxChecks = h.completedDays.length;
        bestHabit = h;
      }
    });

    // 3. Daily Activity (Heatmap-ish data)
    const dailyCounts = Array(totalDays).fill(0);
    habits.forEach(h => {
      h.completedDays.forEach(day => {
        if (day <= totalDays) dailyCounts[day - 1]++;
      });
    });
    const mostProductiveDayIndex = dailyCounts.indexOf(Math.max(...dailyCounts)) + 1;

    // 4. Current Streak (Simple implementation based on today backwards if we knew today, but here just max consecutive days)
    // Actually, let's just do "Longest Streak this Month" for the best habit
    const getLongestStreak = (days) => {
      if (!days.length) return 0;
      const sorted = [...days].sort((a, b) => a - b);
      let maxStreak = 1;
      let currentStreak = 1;
      for (let i = 1; i < sorted.length; i++) {
        if (sorted[i] === sorted[i - 1] + 1) {
          currentStreak++;
        } else {
          maxStreak = Math.max(maxStreak, currentStreak);
          currentStreak = 1;
        }
      }
      return Math.max(maxStreak, currentStreak);
    };
    
    return { completionRate, bestHabit, mostProductiveDayIndex, totalChecks, dailyCounts };
  }, [habitData, currentMonth]);

  // --- Render Helpers ---
  const currentDays = DAYS_IN_MONTH[currentMonth];

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">
      
      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-6 py-4 flex flex-col md:flex-row items-center justify-between shadow-sm">
        <div className="flex items-center space-x-3 mb-4 md:mb-0">
          <div className="bg-blue-600 p-2 rounded-lg">
            <Calendar className="text-white w-6 h-6" />
          </div>
          <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
            Habit Master 2026
          </h1>
        </div>

        <div className="flex items-center bg-slate-100 rounded-lg p-1">
          <button 
            onClick={() => setCurrentMonth(prev => Math.max(0, prev - 1))}
            disabled={currentMonth === 0}
            className="p-2 hover:bg-white rounded-md disabled:opacity-30 transition-all"
          >
            <ChevronLeft size={20} />
          </button>
          <span className="w-32 text-center font-semibold text-slate-700 select-none">
            {MONTH_NAMES[currentMonth]}
          </span>
          <button 
            onClick={() => setCurrentMonth(prev => Math.min(11, prev + 1))}
            disabled={currentMonth === 11}
            className="p-2 hover:bg-white rounded-md disabled:opacity-30 transition-all"
          >
            <ChevronRight size={20} />
          </button>
        </div>

        <div className="hidden md:flex items-center space-x-2">
          <button 
            onClick={exportToCSV}
            className="flex items-center space-x-2 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium"
          >
            <Download size={16} />
            <span>Export CSV</span>
          </button>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 p-4 md:p-8 overflow-hidden flex flex-col">
        
        {/* Analytics Dashboard Section */}
        <section className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <StatCard 
            title="Monthly Completion" 
            value={`${analytics.completionRate}%`} 
            icon={TrendingUp} 
            color="bg-green-500"
            subtext={`${analytics.totalChecks} checks total`}
          />
          <StatCard 
            title="Top Performer" 
            value={analytics.bestHabit ? analytics.bestHabit.name : "None"} 
            icon={Trophy} 
            color="bg-yellow-500"
            subtext="Most consistent habit"
          />
           <StatCard 
            title="Busiest Day" 
            value={`Day ${analytics.mostProductiveDayIndex}`} 
            icon={BarChart2} 
            color="bg-purple-500"
            subtext="Most checks logged"
          />
          <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
             <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-medium text-slate-500">Overall Progress</span>
                <span className="text-sm font-bold text-blue-600">{analytics.completionRate}%</span>
             </div>
             <ProgressBar percentage={analytics.completionRate} colorClass="bg-blue-600" />
          </div>
        </section>

        {/* Interactive Grid Section */}
        <section className="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
          
          {/* Toolbar */}
          <div className="p-4 border-b border-slate-100 flex flex-wrap gap-4 justify-between items-center bg-slate-50">
             <div className="flex items-center space-x-2">
                <input 
                  type="text" 
                  placeholder="New Habit Name..." 
                  className="px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 md:w-64"
                  value={newHabitName}
                  onChange={(e) => setNewHabitName(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && addHabit()}
                />
                <button 
                  onClick={addHabit}
                  className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors"
                >
                  <Plus size={20} />
                </button>
             </div>
             <div className="text-xs text-slate-400 font-medium">
               Click cells to toggle status
             </div>
          </div>

          {/* Scrolling Grid */}
          <div className="overflow-auto flex-1 relative custom-scrollbar">
            <table className="w-full text-left border-collapse">
              <thead className="bg-slate-50 sticky top-0 z-10 shadow-sm">
                <tr>
                  <th className="p-4 border-b border-r border-slate-200 min-w-[200px] font-semibold text-slate-600 sticky left-0 bg-slate-50 z-20">
                    Habit
                  </th>
                  {Array.from({ length: currentDays }).map((_, i) => (
                    <th key={i} className="p-2 border-b border-slate-200 min-w-[40px] text-center text-xs font-semibold text-slate-500">
                      {i + 1}
                    </th>
                  ))}
                  <th className="p-4 border-b border-l border-slate-200 min-w-[100px] text-center font-semibold text-slate-600">
                    Stats
                  </th>
                </tr>
              </thead>
              <tbody>
                {habitData[currentMonth].map((habit, idx) => {
                  const completedCount = habit.completedDays.length;
                  const percent = Math.round((completedCount / currentDays) * 100);
                  
                  return (
                    <tr key={habit.id} className="hover:bg-slate-50 transition-colors group">
                      <td className="p-3 border-b border-r border-slate-200 font-medium text-slate-700 sticky left-0 bg-white group-hover:bg-slate-50 z-10 flex justify-between items-center min-w-[200px]">
                        <span className="truncate pr-2">{habit.name}</span>
                        <button 
                          onClick={() => deleteHabit(idx)}
                          className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity p-1"
                        >
                          <Trash2 size={14} />
                        </button>
                      </td>
                      {Array.from({ length: currentDays }).map((_, dayIdx) => {
                        const dayNum = dayIdx + 1;
                        const isChecked = habit.completedDays.includes(dayNum);
                        return (
                          <td key={dayIdx} className="p-1 border-b border-slate-100 text-center relative">
                            <label className="cursor-pointer w-full h-full block flex items-center justify-center py-2">
                              <input 
                                type="checkbox" 
                                className="peer sr-only"
                                checked={isChecked}
                                onChange={() => toggleDay(idx, dayNum)}
                              />
                              <div className={`w-5 h-5 rounded transition-all duration-200 flex items-center justify-center
                                ${isChecked ? 'bg-blue-500 scale-110 shadow-sm' : 'bg-slate-100 hover:bg-slate-200'}`}>
                                {isChecked && <Check size={14} className="text-white" />}
                              </div>
                            </label>
                          </td>
                        );
                      })}
                      <td className="p-2 border-b border-l border-slate-200 text-center min-w-[100px]">
                        <div className="flex flex-col items-center">
                           <span className={`text-xs font-bold ${percent >= 80 ? 'text-green-600' : percent >= 50 ? 'text-blue-600' : 'text-slate-400'}`}>
                             {percent}%
                           </span>
                           <div className="w-16 bg-slate-200 h-1.5 rounded-full mt-1 overflow-hidden">
                              <div 
                                className={`h-full rounded-full ${percent >= 80 ? 'bg-green-500' : percent >= 50 ? 'bg-blue-500' : 'bg-slate-400'}`} 
                                style={{ width: `${percent}%` }}
                              ></div>
                           </div>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </section>

      </main>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #cbd5e1;
          border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: #94a3b8;
        }
      `}</style>
    </div>
  );
}